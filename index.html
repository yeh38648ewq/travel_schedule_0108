<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…ç¨‹è¦åŠƒå¤§å¸«</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        :root { --primary: #2c3e50; --secondary: #34495e; --accent: #e74c3c; --bg: #f3f4f6; --card-bg: #ffffff; --travel-bg: #eeeeee; --column-width: 320px; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg); color: #333; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .btn { background: var(--secondary); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn:hover { background: #46607a; }
        .btn.active { background: var(--accent); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--accent); }
        .btn-primary:hover { background: #c0392b; }
        .btn-outline { background: transparent; border: 1px solid #ccc; color: #555; }
        .btn-outline:hover { background: #eee; }

        .screen { display: none; height: 100%; flex-direction: column; }
        .screen.active { display: flex; }

        /* Login */
        #loginScreen { justify-content: center; align-items: center; background: linear-gradient(135deg, #2c3e50, #3498db); color: white; }
        .login-box { background: rgba(255,255,255,0.1); padding: 40px; border-radius: 12px; backdrop-filter: blur(10px); text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 300px; }
        .login-btn { width: 100%; margin-bottom: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 10px 20px; border-radius: 50px; cursor: pointer; border: none; font-size: 1rem; transition: 0.2s; }
        .google-btn { background: white; color: #333; }
        .anon-btn { background: #7f8c8d; color: white; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* Dashboard */
        #dashboardScreen { padding: 40px; overflow-y: auto; align-items: center; }
        .dashboard-container { max-width: 900px; width: 100%; }
        .section-title { font-size: 1.2rem; color: var(--secondary); margin: 30px 0 15px 0; border-bottom: 2px solid #ddd; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center;}
        
        .trip-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .trip-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; border-left: 5px solid var(--primary); position: relative; }
        .trip-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .trip-card h3 { margin: 0 0 10px 0; color: var(--primary); font-size: 1.1rem;}
        .trip-card p { margin: 0; color: #7f8c8d; font-size: 0.9rem; word-break: break-all;}
        
        .template-card { border-left-color: #f1c40f; background: #fffcf0; }
        .template-badge { background: #f1c40f; color: #fff; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; vertical-align: middle; margin-left: 5px;}
        .new-trip-card { border: 2px dashed #bdc3c7; background: transparent; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #7f8c8d; min-height: 120px; border-left: none;}
        .new-trip-card:hover { border-color: var(--accent); color: var(--accent); }

        /* Board Styles */
        header { background-color: var(--primary); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        .controls { display: flex; gap: 8px; }
        
        .board-container { flex: 1; overflow-x: auto; padding: 20px; display: flex; gap: 20px; align-items: flex-start; }
        .column { background: #ebecf0; min-width: var(--column-width); max-width: var(--column-width); border-radius: 8px; display: flex; flex-direction: column; max-height: calc(100vh - 100px); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .column-header { padding: 12px 16px; background: #ebecf0; border-top-left-radius: 8px; border-top-right-radius: 8px; border-bottom: 2px solid #ddd; }
        .day-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        
        .card-list { padding: 8px; overflow-y: auto; flex: 1; min-height: 50px; }
        .card { background: var(--card-bg); border-radius: 6px; padding: 12px; margin-bottom: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: grab; border-left: 4px solid #95a5a6; }
        .card.type-travel { border-left-color: #7f8c8d; background-color: var(--travel-bg); }
        .card.type-food { border-left-color: #e67e22; }
        .card.type-spot { border-left-color: #27ae60; }
        
        .card-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 6px; }
        .time { font-weight: 700; color: #e67e22; font-size: 0.9rem; }
        .card-actions { opacity: 0; transition: opacity 0.2s; font-size: 0.8rem; }
        .card:hover .card-actions { opacity: 1; }
        .card-actions span { cursor: pointer; margin-left: 5px; color: #7f8c8d; }
        .card-actions span:hover { color: var(--accent); }

        .link-item, .img-container { margin-top: 5px; position: relative; }
        .link-item { font-size: 0.85rem; background: #f0f2f5; padding: 4px; border-radius: 4px; display: flex; justify-content: space-between; }
        .img-container img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; }
        
        .read-only .card-actions, .read-only .add-card-btn, .read-only .add-day-column, .read-only .delete-day-btn, .read-only .link-remove, .read-only .img-remove { display: none !important; }
        .read-only [contenteditable] { pointer-events: none; }
        [contenteditable]:focus { background-color: rgba(255, 166, 0, 0.1); border-radius: 2px; }

        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1000; display: none; justify-content: center; align-items: center; font-weight: bold; }
    </style>
</head>
<body>

<div id="loading">è™•ç†ä¸­...</div>

<div id="loginScreen" class="screen active">
    <div class="login-box">
        <h1>âœˆï¸ æ—…ç¨‹è¦åŠƒå¤§å¸«</h1>
        <button class="login-btn google-btn" onclick="loginWithGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" alt="G"> ä½¿ç”¨ Google ç™»å…¥
        </button>
        <button class="login-btn anon-btn" onclick="loginAnonymously()">ğŸ•µï¸ åŒ¿å/è¨ªå®¢ç™»å…¥</button>
    </div>
</div>

<div id="dashboardScreen" class="screen">
    <div class="dashboard-container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 id="welcomeMsg">ä½ å¥½</h2>
            <button class="btn btn-outline" onclick="logout()">ç™»å‡º</button>
        </div>
        
        <div class="section-title"><span>ğŸ“š å®˜æ–¹æ¨è–¦è¡Œç¨‹</span></div>
        <div id="templateList" class="trip-grid"></div>

        <div class="section-title"><span>ğŸ‘¤ æˆ‘çš„è¡Œç¨‹è¡¨</span></div>
        <div id="tripList" class="trip-grid"></div>

        <div style="margin-top:40px; padding-top:20px; border-top:1px solid #ddd;">
             <h3>ğŸ¤ åŠ å…¥æœ‹å‹è¡Œç¨‹</h3>
             <input type="text" id="joinCodeInput" style="padding:8px; width:200px;" placeholder="è¼¸å…¥è¡Œç¨‹ ID">
             <button class="btn btn-primary" onclick="joinTrip()">åŠ å…¥</button>
        </div>

        <div style="margin-top:20px; padding-top:20px; border-top:1px solid #ddd;">
             <h3>ğŸ“¤ åŒ¯å…¥è¡Œç¨‹è³‡æ–™ (JSON)</h3>
             <details>
                <summary style="cursor:pointer; color:#7f8c8d;">é»æ“Šå±•é–‹ JSON è²¼ä¸Šå€</summary>
                <textarea id="importJsonInput" style="width:100%; height:150px; margin-top:10px; padding:10px; border:1px solid #ccc; font-family:monospace;" placeholder='è«‹åœ¨æ­¤è²¼ä¸Šå®Œæ•´çš„ JSON'></textarea>
                <button class="btn btn-primary" style="margin-top:10px;" onclick="importTripFromJson()">ç¢ºèªåŒ¯å…¥</button>
             </details>
        </div>
    </div>
</div>

<div id="boardScreen" class="screen">
    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <button class="btn" onclick="backToDashboard()">â† è¿”å›</button>
            <span id="projectTitle" contenteditable="false" onblur="saveTitle()" style="font-weight:bold; font-size:1.2rem;">æœªå‘½åè¡Œç¨‹</span>
        </div>
        <div class="controls">
            <button class="btn" onclick="renameTripId()" title="è‡ªè¨‚è¡Œç¨‹ ID">ğŸ†” æ”¹ID</button>
            <button id="toggleEdit" class="btn" onclick="toggleEditMode()">ğŸ”’ å”¯è®€</button>
            <button id="undoBtn" class="btn" onclick="performUndo()" disabled>â†¶</button>
            <button id="redoBtn" class="btn" onclick="performRedo()" disabled>â†·</button>
            <button class="btn" onclick="copyTripId()">ğŸ“‹ è¤‡è£½</button>
        </div>
    </header>
    <div class="board-container" id="board"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, get, child, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithPopup, signInAnonymously, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // â˜…â˜…â˜… è«‹æ›¿æ›æˆä½ çš„ Firebase Config â˜…â˜…â˜…
    const firebaseConfig = {
        apiKey: "AIzaSyAQvaTOqGpa39l33XTg8r13kMZvtPAA4Ds",
      authDomain: "travelschedule-5fb2f.firebaseapp.com",
      databaseURL: "https://travelschedule-5fb2f-default-rtdb.firebaseio.com",
      projectId: "travelschedule-5fb2f",
      storageBucket: "travelschedule-5fb2f.firebasestorage.app",
      messagingSenderId: "265891148429",
      appId: "1:265891148429:web:bc7602ed700a89f4eae8c4",
      measurementId: "G-C28PN16XJY"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    
    let currentUser = null;
    let currentTripId = null;
    let isReadOnly = true; 
    let currentDataState = ""; 
    let historyStack = [];
    let redoStack = [];

    // æ›è¼‰å…¨åŸŸå‡½å¼
    window.loginWithGoogle = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e=>alert(e.message));
    window.loginAnonymously = () => signInAnonymously(auth).catch(e=>alert(e.message));
    window.logout = () => signOut(auth).then(()=>location.reload());
    window.createTrip = createTrip;
    window.joinTrip = joinTrip;
    window.loadTrip = loadTrip;
    window.backToDashboard = () => { currentTripId = null; showScreen('dashboardScreen'); };
    window.copyTripId = () => navigator.clipboard.writeText(currentTripId).then(()=>alert("å·²è¤‡è£½ ID: " + currentTripId));
    window.copyTemplate = copyTemplate;
    window.renameTripId = renameTripId;
    window.toggleEditMode = toggleEditMode;
    window.performUndo = performUndo;
    window.performRedo = performRedo;
    window.saveTitle = () => update(ref(db, `trips/${currentTripId}`), { projectTitle: document.getElementById('projectTitle').innerText });
    window.saveTrigger = saveTrigger;
    
    // DOM æ“ä½œå‡½å¼
    window.addDay = () => { if(isReadOnly)return; let d=getDataFromDOM().days; d.push({day:`Day ${d.length+1}`, items:[]}); updateData({days:d}); };
    window.deleteDay = (i) => { if(isReadOnly)return; if(confirm('åˆªé™¤?')){ let d=getDataFromDOM().days; d.splice(i,1); updateData({days:d}); }};
    window.addCard = (i) => { if(isReadOnly)return; document.querySelectorAll('.card-list')[i].innerHTML += createCardHTML({time:'09:00', title:'æ–°æ´»å‹•', type:'spot'}); saveTrigger(); };
    window.deleteCard = (el) => { if(isReadOnly)return; el.closest('.card').remove(); saveTrigger(); };
    window.updateType = (el,t) => { if(isReadOnly)return; el.closest('.card').className=`card type-${t}`; saveTrigger(); };
    window.addLink = (el) => { if(isReadOnly)return; let u=prompt("ç¶²å€"); if(u) { el.closest('.card').querySelector('.link-list').innerHTML+=`<div class="link-item"><a href="${u}" target="_blank">ğŸ”— é€£çµ</a><span onclick="this.parentElement.remove();saveTrigger()" style="cursor:pointer">Ã—</span></div>`; saveTrigger(); }};
    window.handleImage = (inp) => { if(isReadOnly || !inp.files[0]) return; let r=new FileReader(); r.onload=e=>{ inp.closest('.card').querySelector('.img-preview').innerHTML+=`<div class="img-container"><img src="${e.target.result}"><div class="img-remove" onclick="this.parentElement.remove();saveTrigger()" style="position:absolute;top:0;right:0;background:red;color:white;width:15px;height:15px;font-size:10px;display:flex;justify-content:center;cursor:pointer;">Ã—</div></div>`; saveTrigger(); }; r.readAsDataURL(inp.files[0]); };

    // åŒ¯å…¥ JSON æ ¸å¿ƒå‡½å¼
    window.importTripFromJson = function() {
        const jsonText = document.getElementById('importJsonInput').value.trim();
        if (!jsonText) { alert("è«‹å…ˆè²¼ä¸Š JSON è³‡æ–™ï¼"); return; }
        try {
            const data = JSON.parse(jsonText);
            if (!data.days || !Array.isArray(data.days)) { alert("æ ¼å¼éŒ¯èª¤ï¼šJSON å¿…é ˆåŒ…å« 'days' é™£åˆ—ï¼"); return; }
            if (!data.projectTitle) data.projectTitle = "åŒ¯å…¥çš„è¡Œç¨‹";
            
            document.getElementById('loading').style.display = 'flex';
            const newRef = push(ref(db, 'trips'));
            set(newRef, data).then(() => {
                update(ref(db, `users/${currentUser.uid}/trip_ids`), { [newRef.key]: true }).then(() => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('importJsonInput').value = '';
                    alert("åŒ¯å…¥æˆåŠŸï¼");
                });
            }).catch(err => { alert("åŒ¯å…¥å¤±æ•—"); console.error(err); document.getElementById('loading').style.display = 'none';});
        } catch (e) { alert("JSON æ ¼å¼éŒ¯èª¤ï¼\n" + e.message); }
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('welcomeMsg').innerText = `Hi, ${user.displayName || 'ç¥ç§˜æ—…äºº'}`;
            showScreen('dashboardScreen');
            loadUserTrips();
            loadTemplates();
        } else { showScreen('loginScreen'); }
    });

    function showScreen(id) { document.querySelectorAll('.screen').forEach(el => el.classList.remove('active')); document.getElementById(id).classList.add('active'); }

    function loadUserTrips() {
        onValue(ref(db, `users/${currentUser.uid}/trip_ids`), async (snap) => {
            const list = document.getElementById('tripList');
            list.innerHTML = `<div class="trip-card new-trip-card" onclick="createTrip()"><span style="font-size:2rem;">+</span><span>+ æ–°è¡Œç¨‹</span></div>`;
            const ids = snap.val() || {};
            for(let tid in ids) {
                const tSnap = await get(child(ref(db), `trips/${tid}/projectTitle`));
                if(tSnap.exists()) {
                    const card = document.createElement('div'); card.className = 'trip-card';
                    card.innerHTML = `<h3>${tSnap.val()}</h3><p>ID: ${tid}</p>`;
                    card.onclick = () => loadTrip(tid);
                    list.appendChild(card);
                }
            }
        });
    }

    function loadTemplates() {
        onValue(ref(db, 'templates'), (snap) => {
            const list = document.getElementById('templateList'); list.innerHTML = ''; 
            const templates = snap.val() || {};
            for (let tid in templates) {
                const tpl = templates[tid];
                const card = document.createElement('div'); card.className = 'trip-card template-card';
                card.innerHTML = `<h3>${tpl.projectTitle} <span class="template-badge">å…¬ç‰ˆ</span></h3><p>å®˜æ–¹æ¨è–¦</p><button class="btn btn-primary" style="margin-top:10px;" onclick="event.stopPropagation(); copyTemplate('${tid}')">ğŸ“¥ è¤‡è£½</button>`;
                list.appendChild(card);
            }
        });
    }

    async function copyTemplate(tid) {
        if(!confirm("è¤‡è£½æ­¤å…¬ç‰ˆè¡Œç¨‹ï¼Ÿ")) return;
        document.getElementById('loading').style.display = 'flex';
        const snap = await get(child(ref(db), `templates/${tid}`));
        const data = snap.val(); data.projectTitle += " (å‰¯æœ¬)";
        const newRef = push(ref(db, 'trips'));
        await set(newRef, data);
        await update(ref(db, `users/${currentUser.uid}/trip_ids`), { [newRef.key]: true });
        document.getElementById('loading').style.display = 'none';
        alert("è¤‡è£½æˆåŠŸï¼");
    }

    function createTrip() {
        const refNew = push(ref(db, 'trips'));
        set(refNew, { projectTitle: "æ–°æ—…ç¨‹", days: [{day:"Day 1", items:[]}] }).then(() => update(ref(db, `users/${currentUser.uid}/trip_ids`), { [refNew.key]: true }));
    }

    function joinTrip() {
        const code = document.getElementById('joinCodeInput').value.trim();
        if(!code) return;
        get(child(ref(db), `trips/${code}`)).then(snapshot => {
             if(snapshot.exists()) { update(ref(db, `users/${currentUser.uid}/trip_ids`), {[code]:true}); alert("åŠ å…¥æˆåŠŸ"); } else { alert("æ‰¾ä¸åˆ°æ­¤ ID"); }
        });
    }

    async function renameTripId() {
        if(isReadOnly) { alert("è«‹å…ˆåˆ‡æ›åˆ°ç·¨è¼¯æ¨¡å¼"); return; }
        const newId = prompt("è«‹è¼¸å…¥æ–°çš„ ID (åªèƒ½è‹±æ–‡æ•¸å­—):", currentTripId);
        if(!newId || newId === currentTripId) return;
        if(!/^[a-zA-Z0-9_-]+$/.test(newId)) { alert("ID åªèƒ½åŒ…å«è‹±æ–‡æ•¸å­—"); return; }
        document.getElementById('loading').style.display = 'flex';
        const checkSnap = await get(child(ref(db), `trips/${newId}`));
        if(checkSnap.exists()) { document.getElementById('loading').style.display = 'none'; alert("ID å·²å­˜åœ¨"); return; }
        const snap = await get(ref(db, `trips/${currentTripId}`));
        await set(ref(db, `trips/${newId}`), snap.val());
        await update(ref(db, `users/${currentUser.uid}/trip_ids`), { [newId]: true, [currentTripId]: null });
        await remove(ref(db, `trips/${currentTripId}`));
        currentTripId = newId; document.getElementById('loading').style.display = 'none'; alert(`ID ä¿®æ”¹ç‚º: ${newId}`); loadTrip(newId);
    }

    function loadTrip(tid) {
        currentTripId = tid; showScreen('boardScreen'); document.getElementById('loading').style.display = 'flex';
        isReadOnly = true; updateEditModeUI(); historyStack = []; redoStack = []; updateUndoButtons();
        onValue(ref(db, `trips/${tid}`), (s) => {
            document.getElementById('loading').style.display = 'none';
            const d = s.val(); if(!d) return;
            const jsonStr = JSON.stringify(d);
            if(jsonStr !== currentDataState) {
                if(!isReadOnly && currentDataState) { historyStack.push(currentDataState); updateUndoButtons(); }
                currentDataState = jsonStr; renderBoard(d);
            }
        });
    }

    function updateData(d) { update(ref(db, `trips/${currentTripId}`), d); }
    function saveTrigger() { if (isReadOnly) return; setTimeout(() => { const n=getDataFromDOM(); const s=JSON.stringify(n); if(s===currentDataState)return; historyStack.push(currentDataState); if(historyStack.length>20)historyStack.shift(); redoStack=[]; updateUndoButtons(); currentDataState=s; updateData(n); }, 100); }
    
    function performUndo() { if(!historyStack.length||isReadOnly)return; redoStack.push(currentDataState); let p=historyStack.pop(); currentDataState=p; let d=JSON.parse(p); renderBoard(d); updateData(d); updateUndoButtons(); }
    function performRedo() { if(!redoStack.length||isReadOnly)return; historyStack.push(currentDataState); let n=redoStack.pop(); currentDataState=n; let d=JSON.parse(n); renderBoard(d); updateData(d); updateUndoButtons(); }
    function updateUndoButtons() { document.getElementById('undoBtn').disabled=(!historyStack.length||isReadOnly); document.getElementById('redoBtn').disabled=(!redoStack.length||isReadOnly); }

    function toggleEditMode() { isReadOnly=!isReadOnly; updateEditModeUI(); if(currentDataState) renderBoard(JSON.parse(currentDataState)); }
    function updateEditModeUI() { const b=document.getElementById('toggleEdit'); const bd=document.getElementById('board'); const t=document.getElementById('projectTitle'); if(isReadOnly){ b.innerText="ğŸ”’ å”¯è®€"; b.classList.remove('active'); bd.classList.add('read-only'); t.contentEditable="false"; }else{ b.innerText="âœï¸ ç·¨è¼¯"; b.classList.add('active'); bd.classList.remove('read-only'); t.contentEditable="true"; } updateUndoButtons(); }

    function renderBoard(d) {
        document.getElementById('projectTitle').innerText = d.projectTitle || "æœªå‘½å";
        const board = document.getElementById('board'); board.innerHTML = '';
        (d.days||[]).forEach((day, i) => {
            const col = document.createElement('div'); col.className='column';
            col.innerHTML = `<div class="column-header"><div class="day-row"><span class="day-title" contenteditable="${!isReadOnly}" onblur="saveTrigger()">${day.day}</span><button class="delete-day-btn" onclick="deleteDay(${i})">Ã—</button></div></div><div class="card-list"></div><button class="add-card-btn" style="width:100%; padding:10px; border:2px dashed #ccc; background:transparent;" onclick="addCard(${i})">+ æ–°å¢</button>`;
            const lst = col.querySelector('.card-list');
            (day.items||[]).forEach(item => lst.innerHTML += createCardHTML(item));
            board.appendChild(col);
            new Sortable(lst, { group:'shared', animation:150, disabled: isReadOnly, onEnd: saveTrigger });
        });
        const addDayCol = document.createElement('div'); addDayCol.className = 'add-day-column'; addDayCol.style.minWidth = '60px'; addDayCol.style.paddingTop = '10px';
        addDayCol.innerHTML = `<button style="width:50px; height:50px; border-radius:50%; border:2px dashed #bdc3c7; color:#7f8c8d; font-size:24px; cursor:pointer; background:rgba(255,255,255,0.5);" onclick="addDay()">+</button>`;
        if(isReadOnly) addDayCol.style.display = 'none'; board.appendChild(addDayCol);
        if(isReadOnly) board.classList.add('read-only'); else board.classList.remove('read-only');
    }

    function createCardHTML(item) {
        let links = (item.links||[]).map(l=>`<div class="link-item"><a href="${l}" target="_blank">ğŸ”— é€£çµ</a><span onclick="this.parentElement.remove();saveTrigger()" style="cursor:pointer" class="link-remove">Ã—</span></div>`).join('');
        let imgs = (item.images||[]).map(s=>`<div class="img-container"><img src="${s}"><div class="img-remove" onclick="this.parentElement.remove();saveTrigger()" style="position:absolute;top:0;right:0;background:red;color:white;width:15px;height:15px;font-size:10px;display:flex;justify-content:center;cursor:pointer;">Ã—</div></div>`).join('');
        return `<div class="card type-${item.type||'spot'}"><div class="card-header"><span class="time" contenteditable="${!isReadOnly}" onblur="saveTrigger()">${item.time}</span><div class="card-actions"><span onclick="updateType(this,'spot')">æ™¯</span><span onclick="updateType(this,'food')">é£Ÿ</span><span onclick="updateType(this,'travel')">è¡Œ</span><span onclick="deleteCard(this)">ğŸ—‘ï¸</span></div></div><div contenteditable="${!isReadOnly}" onblur="saveTrigger()" style="font-weight:bold">${item.title}</div><div style="font-size:0.85rem; color:#666;" contenteditable="${!isReadOnly}" onblur="saveTrigger()">${item.desc||''}</div><div class="link-list">${links}</div><div class="img-preview">${imgs}</div><div class="card-actions" style="margin-top:5px; justify-content:flex-end; display:flex; gap:10px;"><span onclick="addLink(this)">ğŸ”—</span><label>ğŸ“·<input type="file" style="display:none" accept="image/*" onchange="handleImage(this)"></label></div></div>`;
    }
    
    function getDataFromDOM() {
        const days = [];
        document.querySelectorAll('.column').forEach(col => {
            const items = [];
            col.querySelectorAll('.card').forEach(c => {
                let links=[]; c.querySelectorAll('.link-item a').forEach(a=>links.push(a.href));
                let imgs=[]; c.querySelectorAll('.img-preview img').forEach(i=>imgs.push(i.src));
                items.push({ time: c.querySelector('.time').innerText, title: c.children[1].innerText, desc: c.children[2].innerText, type: c.classList.contains('type-food')?'food':(c.classList.contains('type-travel')?'travel':'spot'), links: links, images: imgs });
            });
            days.push({ day: col.querySelector('.day-title').innerText, items: items });
        });
        return { projectTitle: document.getElementById('projectTitle').innerText, days: days };
    }
</script>
</body>
</html>
