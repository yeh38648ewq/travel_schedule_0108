<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…ç¨‹è¦åŠƒå¤§å¸« Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --secondary: #34495e; --accent: #e74c3c; --bg: #ecf0f1; --card-bg: #ffffff; --column-width: 350px; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg); color: #2c3e50; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        
        .btn { background: var(--secondary); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .btn:hover { background: var(--primary); }
        .btn-primary { background: var(--accent); }
        .btn-outline { background: transparent; border: 1px solid var(--secondary); color: var(--secondary); }
        .btn-outline:hover { background: var(--secondary); color: white; }

        .screen { display: none; height: 100%; flex-direction: column; }
        .screen.active { display: flex; }

        /* Login */
        #loginScreen { justify-content: center; align-items: center; background: linear-gradient(135deg, #2c3e50, #4ca1af); color: white; }
        .login-box { background: rgba(255,255,255,0.1); padding: 40px; border-radius: 12px; backdrop-filter: blur(10px); text-align: center; width: 300px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); }
        
        /* Dashboard */
        #dashboardScreen { padding: 40px; overflow-y: auto; }
        .dashboard-container { max-width: 1000px; margin: 0 auto; width: 100%; }
        
        .section-title { font-size: 1.5rem; font-weight: bold; margin: 30px 0 15px; border-left: 5px solid var(--accent); padding-left: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        .trip-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .trip-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s; position: relative; border-top: 5px solid var(--secondary); }
        .trip-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .trip-card h3 { margin: 0 0 10px 0; font-size: 1.1rem; }
        .trip-card .meta { font-size: 0.85rem; color: #7f8c8d; }
        .trip-card .actions { margin-top: 15px; display: flex; gap: 10px; }

        /* Board */
        header { background-color: white; padding: 10px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10; height: 60px;}
        .board-container { flex: 1; overflow-x: auto; padding: 30px; display: flex; gap: 25px; align-items: flex-start; height: calc(100vh - 80px); box-sizing: border-box; }
        
        /* Sortable Columns */
        .column { background: #dfe6e9; min-width: var(--column-width); width: var(--column-width); border-radius: 12px; display: flex; flex-direction: column; max-height: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: background 0.2s; }
        .column.sortable-ghost { opacity: 0.5; background: #b2bec3; }
        
        .column-header { padding: 15px 20px; font-weight: bold; background: #b2bec3; color: #2d3436; border-radius: 12px 12px 0 0; cursor: grab; display: flex; justify-content: space-between; align-items: center; }
        .column-header:active { cursor: grabbing; }
        
        .card-list { padding: 10px; overflow-y: auto; flex: 1; min-height: 50px; }
        .card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 4px solid #bdc3c7; cursor: grab; }
        .card:hover { background: #fdfdfd; }
        .card.type-travel { border-left-color: #3498db; }
        .card.type-food { border-left-color: #e67e22; }
        .card.type-spot { border-left-color: #27ae60; }
        
        .time { font-weight: 800; color: #2c3e50; font-family: monospace; font-size: 1.1em; display: inline-block; min-width: 50px; }
        .link-btn { display: inline-block; margin-top: 8px; font-size: 0.8rem; text-decoration: none; color: #3498db; border: 1px solid #3498db; padding: 2px 8px; border-radius: 10px; }
        .link-btn:hover { background: #3498db; color: white; }

        /* Import Area */
        #importArea { display: none; background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 100px; margin-bottom: 10px; padding: 10px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; }
        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;}

        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: none; justify-content: center; align-items: center; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div id="loading">è¼‰å…¥ä¸­...</div>

<div id="loginScreen" class="screen active">
    <div class="login-box">
        <h1 style="margin-bottom:10px;">ğŸ‡¯ğŸ‡µ æ—…ç¨‹è¦åŠƒå¤§å¸«</h1>
        <p style="font-size:0.9rem; margin-bottom:30px; opacity:0.8;">æ‹–æ›³æ’åºãƒ»å®˜æ–¹æ¨¡æ¿ãƒ»å³æ™‚é›²ç«¯</p>
        <button class="btn btn-primary" style="width:100%; padding:12px;" onclick="loginAnonymously()">é–‹å§‹ä½¿ç”¨</button>
    </div>
</div>

<div id="dashboardScreen" class="screen">
    <div class="dashboard-container">
        
        <div class="section-title">
            <span>ğŸ† å®˜æ–¹æ¨è–¦è¡Œç¨‹</span>
        </div>
        <div id="officialList" class="trip-grid"></div>

        <div class="section-title">
            <span>ğŸ“‚ æˆ‘çš„è¡Œç¨‹</span>
            <button class="btn btn-outline" onclick="toggleImport()">+ åŒ¯å…¥/æ–°å¢</button>
        </div>

        <div id="importArea">
            <div class="input-group">
                <label>è¡Œç¨‹ ID (é¸å¡«ï¼Œè‹¥ç©ºç™½å‰‡è‡ªå‹•ç”¢ç”Ÿ)</label>
                <input type="text" id="importId" placeholder="ä¾‹å¦‚ï¼šjapan-2026-family">
            </div>
            <div class="input-group">
                <label>JSON è³‡æ–™</label>
                <textarea id="jsonInput" placeholder="è«‹åœ¨æ­¤è²¼ä¸Š JSON ä»£ç¢¼"></textarea>
            </div>
            <button class="btn btn-primary" onclick="importTrip()">ç¢ºèªåŒ¯å…¥</button>
        </div>

        <div id="tripList" class="trip-grid"></div>
    </div>
</div>

<div id="boardScreen" class="screen">
    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <button class="btn" onclick="showScreen('dashboardScreen')">â† è¿”å›</button>
            <h2 id="projectTitle" style="margin:0; font-size:1.2rem;">è¡Œç¨‹è¡¨</h2>
        </div>
        <div style="font-size:0.8rem; color:#7f8c8d;">ğŸ’¡ æŒ‰ä½æ¨™é¡Œå¯æ‹–æ›³å¤©æ•¸æ’åº</div>
    </header>
    <div class="board-container" id="board"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // â˜…â˜…â˜… è«‹æ›¿æ›æˆæ‚¨çš„ Firebase Config â˜…â˜…â˜…
    const firebaseConfig = {
        apiKey: "AIzaSyAQvaTOqGpa39l33XTg8r13kMZvtPAA4Ds",
          authDomain: "travelschedule-5fb2f.firebaseapp.com",
          databaseURL: "https://travelschedule-5fb2f-default-rtdb.firebaseio.com",
          projectId: "travelschedule-5fb2f",
          storageBucket: "travelschedule-5fb2f.firebasestorage.app",
          messagingSenderId: "265891148429",
          appId: "1:265891148429:web:bc7602ed700a89f4eae8c4",
          measurementId: "G-C28PN16XJY"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    let uid = null;
    let currentTripId = null;
    let currentTripData = null;

    // å®˜æ–¹è¡Œç¨‹è³‡æ–™ (Westin/æ¹¯å…ƒé¤¨/Ritz é ‚ç´šç‰ˆ)
    const OFFICIAL_TRIPS = [
        {
            id: 'official_japan_lux_2026',
            title: 'ğŸ‡¯ğŸ‡µ 2026 é ‚ç´šåå®¿ãƒ»é›™æ—¥æ»‘é›ª (å®˜æ–¹æ¨è–¦)',
            desc: 'Westinäº¬éƒ½ã€çµç¶æ¹–æ¹¯å…ƒé¤¨ã€ç¦å²¡Ritz Carltonã€‚å«é›™æ—¥æ»‘é›ªèˆ‡å…¨ç†Ÿé£Ÿå®‰æ’ã€‚',
            data: {
              "projectTitle": "ğŸ‡¯ğŸ‡µ 2026 é ‚ç´šåå®¿ãƒ»é›™æ—¥æ»‘é›ª (Westin/æ¹¯å…ƒé¤¨/Ritz)",
              "days": [
                {
                  "day": "Day 1", "title": "ç¦å²¡ç›´è¡äº¬éƒ½ãƒ»å…¥ä½ Westin",
                  "items": [
                    { "time": "11:15", "title": "æŠµé”ç¦å²¡æ©Ÿå ´", "desc": "å°ˆè»Š/è¨ˆç¨‹è»Šç›´é”åšå¤šç«™ã€‚", "type": "travel" },
                    { "time": "13:00", "title": "æ–°å¹¹ç·š âœ äº¬éƒ½", "desc": "Nozomi Green Carã€‚", "type": "travel" },
                    { "time": "16:00", "title": "å…¥ä½ï¼šThe Westin Miyako", "desc": "äº¬éƒ½æœ€å¤§ç´š SPA è¯é ‚ã€‚", "type": "travel" }
                  ]
                },
                {
                  "day": "Day 2", "title": "äº¬éƒ½å°çœ¾ç¦ªæ„ãƒ»SPA",
                  "items": [
                    { "time": "10:30", "title": "é’è“®é™¢é–€è·¡", "desc": "åè‘—è³åº­åœ’ï¼Œç„¡éœ€èµ°è·¯ã€‚", "type": "spot" },
                    { "time": "12:30", "title": "åˆé¤ï¼šå—ç¦ªå¯º é †æ­£", "desc": "æ¹¯è±†è…ååº—ã€‚", "type": "food" },
                    { "time": "18:30", "title": "æ™šé¤ï¼šå¤©å©¦ç¾… äº¬æ˜Ÿ", "desc": "ç±³å…¶æ—ä¸€æ˜Ÿï¼Œå…¨ç†Ÿé£Ÿã€‚", "type": "food" }
                  ]
                },
                {
                  "day": "Day 3", "title": "è¿‘æ±Ÿå…«å¹¡æ°´é„‰ âœ æ¹¯å…ƒé¤¨",
                  "items": [
                    { "time": "11:00", "title": "å…«å¹¡å €ãƒ»æ‰‹æ–èˆ¹", "desc": "æ­èˆ¹éŠè¦½å¤é‹æ²³ã€‚", "type": "spot" },
                    { "time": "16:00", "title": "å…¥ä½ï¼šæ¹¯å…ƒé¤¨", "desc": "æ“æœ‰7ç¨®æº«æ³‰æ± ã€‚", "type": "travel" }
                  ]
                },
                {
                  "day": "Day 4", "title": "æ»‘é›ª Day 1",
                  "items": [
                    { "time": "10:00", "title": "ç§äººæ•™ç·´æ»‘é›ª", "desc": "çµç¶æ¹– Valley ä¸€å°ä¸€æ•™å­¸ã€‚", "type": "spot" },
                    { "time": "16:00", "title": "å›æ¹¯å…ƒé¤¨æ³¡æ¹¯", "desc": "ä¿®å¾©è‚Œè‚‰ã€‚", "type": "travel" }
                  ]
                },
                {
                  "day": "Day 5", "title": "æ»‘é›ª Day 2 âœ ç¦å²¡ Ritz",
                  "items": [
                    { "time": "09:00", "title": "åŠæ—¥æ»‘é›ª", "desc": "æœ€å¾Œé›ªåœ°æ™‚å…‰ã€‚", "type": "spot" },
                    { "time": "13:30", "title": "ç§»å‹•å›ç¦å²¡", "desc": "æ–°å¹¹ç·š Green Carã€‚", "type": "travel" },
                    { "time": "17:00", "title": "å…¥ä½ï¼šRitz Carlton", "desc": "ç¦å²¡æœ€é ‚ç´šå¥¢è¯ã€‚", "type": "travel" }
                  ]
                },
                {
                  "day": "Day 6", "title": "æ—©èµ· âœ æ©Ÿå ´",
                  "items": [
                    { "time": "08:15", "title": "å‰å¾€æ©Ÿå ´", "desc": "è¨ˆç¨‹è»Š 20 åˆ†é˜ã€‚", "type": "travel" },
                    { "time": "11:15", "title": "èµ·é£›", "desc": "è¿”å°ã€‚", "type": "travel" }
                  ]
                }
              ]
            }
        }
    ];

    // æ ¸å¿ƒåŠŸèƒ½
    window.loginAnonymously = () => {
        document.getElementById('loading').style.display = 'flex';
        signInAnonymously(auth).catch(e => alert(e.message));
    };
    
    window.showScreen = (id) => { 
        document.querySelectorAll('.screen').forEach(e => e.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
    };

    window.toggleImport = () => { 
        const el = document.getElementById('importArea'); 
        el.style.display = el.style.display === 'block' ? 'none' : 'block'; 
    };

    onAuthStateChanged(auth, user => {
        document.getElementById('loading').style.display = 'none';
        if (user) { 
            uid = user.uid; 
            showScreen('dashboardScreen'); 
            loadUserTrips(); 
            renderOfficialTrips();
        }
    });

    // 1. æ¸²æŸ“å®˜æ–¹è¡Œç¨‹
    function renderOfficialTrips() {
        const list = document.getElementById('officialList');
        list.innerHTML = '';
        OFFICIAL_TRIPS.forEach(trip => {
            const div = document.createElement('div');
            div.className = 'trip-card';
            div.style.borderTopColor = '#e74c3c'; // ç´…è‰²å¼·èª¿
            div.innerHTML = `
                <h3>${trip.title}</h3>
                <div class="meta">${trip.desc}</div>
                <div class="actions">
                    <button class="btn btn-outline" style="width:100%" onclick="saveOfficialTrip('${trip.id}')">ğŸ“¥ å¦å­˜ç‚ºæˆ‘çš„è¡Œç¨‹</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // 2. å¦å­˜å®˜æ–¹è¡Œç¨‹é‚è¼¯
    window.saveOfficialTrip = (officialId) => {
        const trip = OFFICIAL_TRIPS.find(t => t.id === officialId);
        if(!trip) return;
        
        const newTitle = prompt("è«‹ç‚ºé€™å€‹è¡Œç¨‹å‘½åï¼š", trip.title);
        if(!newTitle) return;

        const newTripData = JSON.parse(JSON.stringify(trip.data)); // Deep copy
        newTripData.projectTitle = newTitle;

        const newRef = push(ref(db, `users/${uid}/trips`));
        set(newRef, { title: newTitle, data: newTripData }).then(() => {
            alert("å·²æˆåŠŸå„²å­˜åˆ°æ‚¨çš„è¡Œç¨‹åˆ—è¡¨ï¼");
            loadUserTrips();
        });
    };

    // 3. è¼‰å…¥ä½¿ç”¨è€…è¡Œç¨‹
    function loadUserTrips() {
        onValue(ref(db, `users/${uid}/trips`), snap => {
            const list = document.getElementById('tripList'); 
            list.innerHTML = '';
            const data = snap.val() || {};
            
            if(Object.keys(data).length === 0) {
                list.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#999;">æ‚¨é‚„æ²’æœ‰è¡Œç¨‹ï¼Œè«‹åŒ¯å…¥æˆ–å¾å®˜æ–¹æ¨è–¦æ–°å¢ã€‚</div>';
                return;
            }

            Object.keys(data).forEach(key => {
                const div = document.createElement('div'); 
                div.className = 'trip-card';
                div.innerHTML = `
                    <h3>${data[key].title}</h3>
                    <div class="meta">ID: ${key}</div>
                    <div class="actions">
                        <button class="btn btn-primary" style="flex:1" onclick="loadBoard('${key}')">ç·¨è¼¯/æŸ¥çœ‹</button>
                    </div>
                `;
                list.appendChild(div);
            });
        });
    }

    // 4. åŒ¯å…¥è¡Œç¨‹ (å«è‡ªè¨‚ ID)
    window.importTrip = () => {
        try {
            const jsonText = document.getElementById('jsonInput').value;
            if(!jsonText) return alert("è«‹è¼¸å…¥ JSON");
            
            const data = JSON.parse(jsonText);
            const customId = document.getElementById('importId').value.trim();

            // å¦‚æœæœ‰è‡ªè¨‚ IDï¼Œä½¿ç”¨ child(ID).set()ï¼Œå¦å‰‡ç”¨ push()
            if (customId) {
                const customRef = ref(db, `users/${uid}/trips/${customId}`);
                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ (éå¿…è¦ï¼Œçœ‹æ‚¨æ˜¯å¦æƒ³è¦†è“‹)
                get(customRef).then((snapshot) => {
                    if (snapshot.exists() && !confirm("æ­¤ ID å·²å­˜åœ¨ï¼Œç¢ºå®šè¦è¦†è“‹å—ï¼Ÿ")) {
                        return;
                    }
                    set(customRef, { title: data.projectTitle, data: data }).then(afterImport);
                });
            } else {
                const newRef = push(ref(db, `users/${uid}/trips`));
                set(newRef, { title: data.projectTitle, data: data }).then(afterImport);
            }
        } catch (e) { alert('JSON æ ¼å¼éŒ¯èª¤ï¼š' + e); }
    };

    function afterImport() {
        document.getElementById('importArea').style.display = 'none';
        document.getElementById('jsonInput').value = '';
        document.getElementById('importId').value = '';
        alert('åŒ¯å…¥æˆåŠŸï¼');
    }

    // 5. è¼‰å…¥çœ‹æ¿ (å« Column æ‹–æ›³åŠŸèƒ½)
    window.loadBoard = (key) => {
        currentTripId = key;
        const board = document.getElementById('board'); 
        board.innerHTML = '';
        showScreen('boardScreen');

        // ç›£è½è³‡æ–™è®ŠåŒ–
        onValue(ref(db, `users/${uid}/trips/${key}`), snap => {
            const trip = snap.val();
            if(!trip) return;
            
            currentTripData = trip.data; // ä¿æŒæœ¬åœ°è³‡æ–™åŒæ­¥
            document.getElementById('projectTitle').innerText = trip.title;
            board.innerHTML = ''; // æ¸…ç©ºé‡ç¹ª

            // ç¹ªè£½æ¯ä¸€å¤© (Column)
            currentTripData.days.forEach((day, index) => {
                const col = document.createElement('div'); 
                col.className = 'column';
                col.setAttribute('data-day-index', index); // å„²å­˜ç´¢å¼•ä»¥ä¾¿æ’åº

                let cardsHtml = '';
                (day.items || []).forEach(item => {
                    let links = (item.links||[]).map(l => `<a href="${l}" target="_blank" class="link-btn">é€£çµ</a>`).join('');
                    cardsHtml += `<div class="card type-${item.type}">
                        <div style="display:flex; justify-content:space-between;"><span class="time">${item.time}</span></div>
                        <div style="font-weight:bold; margin:5px 0;">${item.title}</div>
                        <div style="color:#636e72; font-size:0.9rem; line-height:1.4;">${item.desc}</div>
                        ${links ? `<div style="margin-top:5px;">${links}</div>` : ''}
                    </div>`;
                });
                
                // Header (Handle for dragging)
                col.innerHTML = `
                    <div class="column-header" title="æŒ‰ä½é€™è£¡æ‹–æ›³æ’åº">
                        <span>${day.day} - ${day.title}</span>
                        <span style="cursor:grab">â˜°</span>
                    </div>
                    <div class="card-list">${cardsHtml}</div>
                `;
                board.appendChild(col);
            });

            // â˜…â˜…â˜… å•Ÿç”¨ Column æ‹–æ›³ (å¤©æ•¸æ’åº) â˜…â˜…â˜…
            new Sortable(board, {
                animation: 150,
                handle: '.column-header', // åªèƒ½æŠ“æ¨™é¡Œä¾†æ‹–æ›³
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    // æ›´æ–°æœ¬åœ°é™£åˆ—é †åº
                    const oldIndex = evt.oldIndex;
                    const newIndex = evt.newIndex;
                    
                    if (oldIndex === newIndex) return;

                    // ç§»å‹•é™£åˆ—å…ƒç´ 
                    const movedDay = currentTripData.days.splice(oldIndex, 1)[0];
                    currentTripData.days.splice(newIndex, 0, movedDay);

                    // å¯«å› Firebase
                    update(ref(db, `users/${uid}/trips/${currentTripId}`), { data: currentTripData })
                        .then(() => console.log('å¤©æ•¸é †åºå·²æ›´æ–°'))
                        .catch(err => alert('æ›´æ–°å¤±æ•—'));
                }
            });
        });
    }
</script>
</body>
</html>
